<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<head>
<style type="text/css">
<!--
	html, body {width:100%; height:100%; margin:0px; padding:0px;}
-->
</style>
   <script	language=javascript	src="APIWrapper.js"></script>
    <script	language=javascript	src="SCOFunctions.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />
<title>测试DEMO</title>
<script type="text/javascript" language="javascript">
    loadPage();
	var lessonLength=2;//此变量根据每门课的真实页面数重新赋值
	var init_data="";
	var progresslesson=0;
    var isInternetExplorer = navigator.appName.indexOf("Microsoft") != -1;
	var VisitedSwfName = "";
	var MainObj = isInternetExplorer ? document.all.index : document.index;
	var tempVisitedSwfName="";
    var rawScore=0;
	
	//set init_data and tempVisitedSwfName
	GetInitData()
	
	if (VisitedSwfName == "")
	{
	    VisitedSwfName = tempVisitedSwfName;
	}

	var BeFound = false;
	var countSWF = new Array();
	
    function debug(msg)
	{
	    //alert("debug::"+msg);
	}
	
	function openNewWindow(args){
	   window.open(args);
	}

    //because flash can not invoke functions in .js file, the following functions are for flash interacting
    
    function setCurrentSwfName(args) {
		/*在Scorm中可以考虑取消VisitedSwfName的记录*/
        /*--begin--*/
		BeFound = false;
    	if (VisitedSwfName == "" || VisitedSwfName == undefined){
          	VisitedSwfName = args;
       	}else{
         	countSWF = VisitedSwfName.split(",");
         	for (var i = 0; i < countSWF.length; i++){
        		if (countSWF[i] == args){
               		BeFound = true;
              		break;  
            	}
         	}
        	if (!BeFound){
              	VisitedSwfName = VisitedSwfName + "," + args;
       		}
   		}
   		debug("SetCurrentSwfName::visitedname="+VisitedSwfName);
   		/*--end--*/
	}

   
	//解析Lesson_Location / suspend_data
    //0 for original suspenddata; 1 for lesson_location;
    function GetInitData()
    {
        //this statement is for suspend_data
        locationstring=doLMSGetValue("cmi.suspend_data");
        rawScore=GetRawScore();
        //this statement is for lesson_location
        //locationstring=doLMSGetValue("cmi.core.lesson_location");
        debug("ParseLocationString::string="+locationstring);
        arraystr=locationstring.split('#');
        debug("ParseLocationString::arraylength"+arraystr.length)
        if(arraystr.length>0)
            init_data=arraystr[0];
        if(arraystr.length>1)
            tempVisitedSwfName=arraystr[1];
    }

    //Rebuild Location String
    function RebuildLocationString(suspenddata, locationdata)
    {
        return suspenddata+"#"+locationdata;
    }
    
    //注意这个部分的方法名
    //设置字符串SetSuspendData
    //invoked from swf
    function SetTotalScore(data)
    {
        /*在Scorm中可以考虑取消VisitedSwfName的记录*/
        /*--begin--*/
        debug("SetTotalScore::string="+data);
        countSWF = VisitedSwfName.split(",");
        progresslesson = Math.round((countSWF.length/lessonLength)*100);
        debug("SetTotalScore::Progress="+progresslesson);
        /*--end--*/
        init_data=data;
        debug("SetTotalScore::string="+RebuildLocationString(init_data,VisitedSwfName));
        doLMSSetValue("cmi.suspend_data",RebuildLocationString(init_data,VisitedSwfName));
        //set raw score
        arraystr=data.split(';');
        debug("SetTotalScore::RawScore="+arraystr[2]);
        SetRawScore(arraystr[2]);
	    rawScore=arraystr[2];
    }

	
    //设置课程状态
    function SetCourseStatus(status)
    {
        doLMSSetValue("cmi.core.lesson_status",status);
    }
    //获取课程状态
    function GetCourseStatus()
    {
        return doLMSGetValue("cmi.core.lesson_status");
    } 
    
    //获取课程总分
    function GetRawScore()
    {
        return doLMSGetValue("cmi.core.score.raw");
    }
    //设置课程总分
    function SetRawScore(score)
    {
        //debug(score);
        doLMSSetValue("cmi.core.score.raw",score);
    }
         
   function closeIE(data)
   {
      SetTotalScore(data);
      //unload(); 
	//  top.exit(false);
top.close();
   }
   
   function unload()
   {
     // rawScore=GetRawScore();
     //set lesson status
      var mode = doLMSGetValue( "cmi.core.lesson_mode" );
      debug("closeIE::rawscore="+rawScore+";progresslesson="+progresslesson+";mode="+mode);
      var status;
        
      if ( mode != "review"  &&  mode != "browse" )
      {
        if(progresslesson<99)
        {
            status= "incomplete";
        }
        else
        {
            if ( parseInt(rawScore) >= 60 )
            {
                status= "passed";
            }
            else 
            {
                status="failed";
            }
        }
      }
      //doQuit(status);
   }
   </script>
<script language="JavaScript" type="text/javascript">
<!--
// -----------------------------------------------------------------------------
// Globals
// Major version of Flash required
var requiredMajorVersion = 9;
// Minor version of Flash required
var requiredMinorVersion = 0;
// Revision of Flash required
var requiredRevision = 0;
// the version of javascript supported
var jsVersion = 1.0;
// -----------------------------------------------------------------------------

	function getID(swfID) {
		debug("GetID::swfid::"+swfID)
		if (navigator.appName.indexOf("Microsoft") != -1) {
			return window[swfID];
		}else{
			return document[swfID];
		}
	}
	
	function init(){
	    sectioncount=15;
	    debug("init()::init_data::"+init_data);
        if(init_data=="")
        {
            debug(sectioncount);
            score="";
            loc="";
            for(i=0;i<sectioncount;i++)
            {
                score=score+"0,0,";
                loc=loc+"1,";
            }
            loc=loc.substr(0,loc.length-1);
            score=score.substr(0,score.length-1);            
            init_data=score+";"+loc+";"+"0";
            debug("init()::init_data::"+init_data);
            rawScore=0; 
            debug("init()::rawScore::"+rawScore);              
        }
        //getID("va_fly").putToArray(init_data);
	}
	
	function setLesson(str){
			//lessonLength=str;
	}

	function setsuspenddata(str){
		//alert(str.toString);
		doLMSSetValue( "cmi.suspend_data", str );
	}
	function setprogressdata(str){
		//alert(str);
		doLMSSetValue( "cmi.core.lesson_progress", str );
	}
	function setSSS(fy){
		//alert(fy);
		doContinue(fy);
	}
-->
</script>
<script language="VBScript" type="text/vbscript">
<!-- // Visual basic helper required to detect Flash Player ActiveX control version information
Function VBGetSwfVer(i)
  on error resume next
  Dim swControl, swVersion
  swVersion = 0
  
  set swControl = CreateObject("ShockwaveFlash.ShockwaveFlash." + CStr(i))
  if (IsObject(swControl)) then
    swVersion = swControl.GetVariable("$version")
  end if
  VBGetSwfVer = swVersion
End Function
// -->
</script>
<script language="JavaScript1.1" type="text/javascript">
<!-- // Detect Client Browser type
var isIE  = (navigator.appVersion.indexOf("MSIE") != -1) ? true : false;
var isWin = (navigator.appVersion.toLowerCase().indexOf("win") != -1) ? true : false;
var isOpera = (navigator.userAgent.indexOf("Opera") != -1) ? true : false;
jsVersion = 1.1;
// JavaScript helper required to detect Flash Player PlugIn version information
function JSGetSwfVer(i){
	// NS/Opera version >= 3 check for Flash plugin in plugin array
	if (navigator.plugins != null && navigator.plugins.length > 0) {
		if (navigator.plugins["Shockwave Flash 2.0"] || navigator.plugins["Shockwave Flash"]) {
			var swVer2 = navigator.plugins["Shockwave Flash 2.0"] ? " 2.0" : "";
      		var flashDescription = navigator.plugins["Shockwave Flash" + swVer2].description;
			descArray = flashDescription.split(" ");
			tempArrayMajor = descArray[2].split(".");
			versionMajor = tempArrayMajor[0];
			versionMinor = tempArrayMajor[1];
			if ( descArray[3] != "" ) {
				tempArrayMinor = descArray[3].split("r");
			} else {
				tempArrayMinor = descArray[4].split("r");
			}
      		versionRevision = tempArrayMinor[1] > 0 ? tempArrayMinor[1] : 0;
            flashVer = versionMajor + "." + versionMinor + "." + versionRevision;
      	} else {
			flashVer = -1;
		}
	}
	// MSN/WebTV 2.6 supports Flash 4
	else if (navigator.userAgent.toLowerCase().indexOf("webtv/2.6") != -1) flashVer = 4;
	// WebTV 2.5 supports Flash 3
	else if (navigator.userAgent.toLowerCase().indexOf("webtv/2.5") != -1) flashVer = 3;
	// older WebTV supports Flash 2
	else if (navigator.userAgent.toLowerCase().indexOf("webtv") != -1) flashVer = 2;
	// Can't detect in all other cases
	else {
		
		flashVer = -1;
	}
	return flashVer;
} 
// If called with no parameters this function returns a floating point value 
// which should be the version of the Flash Player or 0.0 
// ex: Flash Player 7r14 returns 7.14
// If called with reqMajorVer, reqMinorVer, reqRevision returns true if that version or greater is available
function DetectFlashVer(reqMajorVer, reqMinorVer, reqRevision) 
{
 	reqVer = parseFloat(reqMajorVer + "." + reqRevision);
   	// loop backwards through the versions until we find the newest version	
	for (i=25;i>0;i--) {	
		if (isIE && isWin && !isOpera) {
			versionStr = VBGetSwfVer(i);
		} else {
			versionStr = JSGetSwfVer(i);		
		}
		if (versionStr == -1 ) { 
			return false;
		} else if (versionStr != 0) {
			if(isIE && isWin && !isOpera) {
				tempArray         = versionStr.split(" ");
				tempString        = tempArray[1];
				versionArray      = tempString .split(",");				
			} else {
				versionArray      = versionStr.split(".");
			}
			versionMajor      = versionArray[0];
			versionMinor      = versionArray[1];
			versionRevision   = versionArray[2];
			
			versionString     = versionMajor + "." + versionRevision;   // 7.0r24 == 7.24
			versionNum        = parseFloat(versionString);
        	// is the major.revision >= requested major.revision AND the minor version >= requested minor
			if ( (versionMajor > reqMajorVer) && (versionNum >= reqVer) ) {
				return true;
			} else {
				return ((versionNum >= reqVer && versionMinor >= reqMinorVer) ? true : false );	
			}
		}
	}	
	return (reqVer ? false : 0.0);
}
// -->
<!--
var isInternetExplorer = navigator.appName.indexOf("Microsoft") != -1;
// Handle all the FSCommand messages in a Flash movie.
function main_DoFSCommand(command, args) {
	var mainObj = isInternetExplorer ? document.all.main : document.main;
	//
	// Place your code here.
alert(command);
	doContinue(command);
	//
}
// Hook for Internet Explorer.
if (navigator.appName && navigator.appName.indexOf("Microsoft") != -1 && navigator.userAgent.indexOf("Windows") != -1 && navigator.userAgent.indexOf("Windows 3.1") == -1) {
	document.write('<script language=\"VBScript\"\>\n');
	document.write('On Error Resume Next\n');
	document.write('Sub main_FSCommand(ByVal command, ByVal args)\n');
	document.write('	Call main_DoFSCommand(command, args)\n');
	document.write('End Sub\n');
	document.write('</script\>\n');
}
//-->
</script>
</head>
<body bgcolor="#FFFFFF" topmargin="0" leftmargin="0" onload="init()" onunload="unloadPage()">
<div align="center" id="flashcontent"></div>
<script type="text/javascript" src="swfobject.js"></script>
<script language="JavaScript" type="text/javascript">
<!-- 
	var hasRightVersion = DetectFlashVer(requiredMajorVersion, requiredMinorVersion, requiredRevision);
	if(hasRightVersion) {  // if we've detected an acceptable version
   		var so=new SWFObject ("main.swf", "va_fly", "800", "600", "9", "#FFFFFF") ;
    	so.addParam("quality", "high") ;
   		so.addParam ("wmode", "transparent") ;
		so.addParam ("loop", "false") ;
    	so.addParam ("menu", "false") ;
    	so.addParam ("align", "default") ;
		so.addParam ("allowScriptAccess", "sameDomain") ;//<param name="always" value="sameDomain" />
	   if (suspenddata_str!=""){
		  //alert(suspenddata_str);
		  //document.va_fly.SetVariable("arr_chaptercpl_str", suspenddata_str);
		  so.addVariable("arr_chaptercpl_str", suspenddata_str);
	   } else {
		  //document.va_fly.SetVariable("arr_chaptercpl_str", "");
		  so.addVariable("arr_chaptercpl_str", "");
	   }
    	so.write ("flashcontent") ;
  } else {  // flash is too old or we can't detect the plugin
   		var so=new SWFObject ("getPlayer.swf", "下载插件", "1", "1", "6", "#ffffff") ;
    	so.addParam("quality", "high") ;
    	so.addParam ("menu", "false") ;
    	so.write ("flashcontent") ;
		var alternateContent = '<center><p>&nbsp;</p><p>需要下载新版<a href="download/flash_player_9.msi">Flash Play播放器</a></p><p>安装完成后，请关闭并重新打开浏览器</p></center>'
    	document.write(alternateContent);  // insert non-flash content
  }
// -->
</script>
</body>
</html>
